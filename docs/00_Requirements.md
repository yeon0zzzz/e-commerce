# 요구사항
- 기능적 요구사항 : 제공 가능한 기능
- 비기능적 요구사항 : 성능, 확장성, 보안 관련 추가 고려사항


## 필수 구현 API
- 잔액 충전 / 조회 API
- 상품 조회 API
- 주문 / 결제 API
- 선착순 쿠폰 API
- 인기 판매 상품 조회 API


### ✅ 기능적 요구사항

- [ ] **잔액 관리 (`Point`)**
    - [ ] 사용자는 포인트(잔액)를 충전할 수 있어야 한다.
    - [ ] 충전 금액은 0보다 커야 한다.
    - [ ] 충전 시 `point_history`에 기록되어야 한다.
    - [ ] 사용자는 포인트(잔액)를 조회할 수 있어야 한다.
    - [ ] 사용자는 포인트 사용 내역을 조회할 수 있어야 한다.

- [ ] **상품 조회 (`Product`, `Inventory`)**
    - [ ] 사용자는 상품 목록을 조회할 수 있어야 한다.
    - [ ] 사용자는 상품 상세 정보를 조회할 수 있어야 한다.
    - [ ] 사용자는 상품의 재고 수량을 함께 확인할 수 있어야 한다.

- [ ] **주문 생성 (`Order`, `OrderItem`)**
    - [ ] 사용자는 원하는 상품을 선택하여 주문을 생성할 수 있어야 한다.
    - [ ] 주문 시 재고 수량보다 많으면 주문은 실패해야 한다.
    - [ ] 주문 생성 시 주문 상태는 기본적으로 `CREATED` 상태여야 한다.

- [ ] **결제 (Payment)**
    - [ ] 사용자는 주문을 결제할 수 있어야 한다.
    - [ ] 결제 수단은 포인트 또는 외부 수단 중 선택 가능해야 한다.
    - [ ] 결제 시 사용 가능한 쿠폰을 선택해 적용할 수 있어야 한다.
    - [ ] 쿠폰은 1개 또는 복수 적용 가능하다.
    - [ ] 쿠폰의 할인 금액만큼 `discount_amount`가 계산되어야 한다.
    - [ ] 최종 결제 금액은 포인트를 차감한 금액이어야 한다.
    - [ ] 결제 성공 시 관련 상태 및 이력이 업데이트되어야 한다.
    - [ ] 결제 실패 시 트랜잭션은 롤백되어야 한다.

- [ ] **주문 내역 조회**
    - [ ] 사용자는 본인의 주문 내역을 조회할 수 있어야 한다.
    - [ ] 주문 상세 조회 시 주문 상태, 상품 목록, 결제 정보 등을 확인할 수 있어야 한다.

- [ ] **인기 상품 조회 (`PopularProduct`)**
    - [ ] 사용자는 인기 상품 목록을 조회할 수 있어야 한다.
    - [ ] 기준은 현재 시점 기준 최근 72시간 내 주문된 Top 5 판매 상품이다.

- [ ] **쿠폰 (`Coupon`, `UserCoupon`, `OrderCoupon`)**
    - [ ] 사용자는 사용 가능한 쿠폰을 조회할 수 있어야 한다.
    - [ ] 사용자는 선착순 쿠폰 발급이 가능해야 한다.
    - [ ] 동일 쿠폰 중복 발급은 불가하다.
    - [ ] 사용자는 발급받은 쿠폰을 주문에 적용할 수 있어야 한다.
    - [ ] 쿠폰 사용 시 상태는 사용 처리되어야 하며, 주문과 연결되어야 한다.

---

### ✅ 비기능적 요구사항

- [ ] 결제, 재고 차감, 포인트 차감, 쿠폰 사용은 트랜잭션으로 원자성 보장되어야 한다.
- [ ] 선착순 쿠폰 발급 시 동시성 제어를 통해 중복 발급이 방지되어야 한다. (향후 Redis 고려)
- [ ] 쿠폰은 유효기간 및 상태가 `ACTIVE`인 경우에만 사용 가능해야 한다.
- [ ] 인기 상품은 최근 72시간 기준으로 실시간 쿼리되며, 추후 Redis 등 캐시 적용 가능해야 한다.
- [ ] 포인트/재고는 음수 불가, 정합성이 보장되어야 한다.
- [ ] 주문 상태, 결제 상태는 별도 테이블을 통해 이력 관리되어야 하며, 시점 정보가 포함되어야 한다.


## 🧩 정책 구체화

### 🎁 쿠폰 발급 정책
항목 | 결정사항 | 내용
-- | -- | --
발급 수량 제한 | O | 총 수량 1,000,000 maxCount필드 추가
사용자별 제한 | O | 1인 1쿠폰사용자 ID + 쿠폰 ID로 중복 발급 체크
유효 기간 | O | 만료기간 expiresAt 필드 추가
중복 사용 불가 | O | 1인 1쿠폰 + 사용여부 확인 used 플래그로 관리(bool)
선착순 기준 | O | 현재는 Queue 기반 (추후 Redis 고려)먼저 발급받은 순서대로 수량 제한
동시성 처리 | O | Lock

---

### 🥇 인기 상품 정책
**1️⃣ 쿼리하는 시점 기준 (NOW() - 3일)**
- 장점: 최신 데이터를 포함
- 단점: 트래픽이 크면 부하가 큼

**2️⃣ 오늘을 제외한 최근 3일**
- 장점: 트래픽이 많은경우 캐싱을 통해 부하를 줄일 수 있음(트래픽이 적은 시간대 매일새벽 3시 캐싱)
- 단점: 최신 데이터를 미포함 하여 트렌드에 뒤쳐짐

✅ **결정: 1안 쿼리 시점으로 3일**
결정 이유(사전적 의미)
- `최근` : 얼마 되지 않은 지나간 날부터 현재 또는 **바로 직전까지의 기간**
    - 실시간에 통계에 대한 성능은 추후 고도화를 통해 개선(Redis 도입 등)

